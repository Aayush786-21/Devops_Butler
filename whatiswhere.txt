# DevOps Butler - Codebase Location Guide
# Last Updated: 2025-01-XX

## Recent Updates (Latest Session)

### AI-Powered Project Analysis with Gemini (Enhanced)
- **New Feature**: AI analysis of imported projects using Google Gemini AI
- **Location**: `project_analyzer.py` - Analyzes project structure to detect build/start commands, ports, frameworks, etc.
- **Integration**: 
  - Triggered automatically in background after repository is cloned during import
  - Reads Gemini API key from `.env` file (`GEMINI_API_KEY`)
  - Updates deployment record with detected build_command, start_command, and port
  - Runs asynchronously so import doesn't block
  - **Deployment Integration**: AI analysis results are used by `process_deployment.py` as the second priority (after static site detection, but before Docker/file-based detection) when detecting build and start commands during deployment.
- **Enhanced Static Site Detection**:
  - **Priority 1**: Checks for static HTML files FIRST before AI analysis
  - **AI Prompt Enhancement**: Explicitly instructs AI to detect static sites and never suggest `pip install -r requirements.txt` for static sites
  - **Validation**: Validates AI suggestions - if AI suggests `pip install -r requirements.txt`, verifies that `requirements.txt` exists AND Python entry points exist
  - **Override Logic**: If static site detected (via HTML files or AI framework detection), forces `build_command=None`, `start_command=python3 -m http.server 8080`, `port=8080`
  - **Fallback**: If AI analysis fails or provides incorrect results, uses file-based detection as fallback
- **Analysis Results**: 
  - Framework/Technology Stack (validated)
  - Build Command (validated - never suggests requirements.txt if file doesn't exist)
  - Start Command (validated)
  - Install Command (validated)
  - Port Number (validated - default 8080 if invalid)
  - Root Directory
  - Environment Variables
  - Additional Notes
- **Dependencies**: `google-generativeai` package (added to requirements.txt)
- **Error Handling**: Analysis failures don't block import - gracefully handles errors with fallbacks
- **Location**: `project_analyzer.py`, `orchestrator.py` (import endpoint), `process_deployment.py` (deployment logic), `requirements.txt`
- **Command Detection Priority**: The deployment logic now follows this priority order: 1) Static HTML site detection (highest priority), 2) User-provided commands, 3) AI analysis results from database (validated), 4) Docker-based detection (docker-compose.yml, Dockerfile), 5) File-based detection (package.json, requirements.txt, etc.). Static site detection always overrides AI results to prevent misclassification.
- **Robustness**: Deployment never fails completely - always uses fallbacks (static HTTP server) if detection fails or commands are invalid.

### MAJOR ARCHITECTURE CHANGE - VM-Based Deployment with OrbStack
- **New Deployment Model**: Each user gets an isolated OrbStack VM for deployments
- **Rationale**: Prevents excessive file creation on Mac host, provides isolation between users, cleaner file system
- **VM Management**: `vm_manager.py` - Creates and manages OrbStack VMs per user
- **VM Creation**: Automatically created when user registers (asynchronous, non-blocking)
- **VM Setup**: VMs are Ubuntu-based and automatically configured with dependencies (git, nodejs, python3, npm, etc.)
- **Deployment Flow**: 
  1. User registers → VM created automatically (`butler-user-{user_id}`)
  2. User imports repo → Repo cloned inside VM (`/home/{username}/projects/{deployment_id}`) - dynamically detects VM username
  3. Build command executed inside VM (if needed)
  4. Start command executed inside VM (background process with nohup)
  5. Domain configured: `project-name.butler.aayush786.xyz` → `localhost:{port}` (via Cloudflare tunnel)
- **Project Directory Format**: `/home/{username}/projects/{deployment_id}` (dynamically detected username, e.g., `/home/ubuntu/projects/1` or `/home/aayush/projects/1`)
- **Migration**: Old deployments with `/projects/{deployment_id}` are automatically migrated to `/home/{username}/projects/{deployment_id}` during deployment
- **Database Changes**: Added VM fields to `Deployment` model:
  - `vm_name` (TEXT) - OrbStack VM name (e.g., "butler-user-1")
  - `vm_ip` (TEXT) - VM IP address
  - `host_port` (INTEGER) - Host port (forwarded from VM)
- **VM Lifecycle**: VMs are created on user registration, persist across deployments, and can be deleted when user is deleted
- **Domain Format**: `project-name.butler.aayush786.xyz` (with dot, not hyphen)
- **Cloudflare Integration**: Domains automatically configured in Cloudflare tunnel after deployment
- **Location**: `vm_manager.py`, `auth.py` (user registration), `orchestrator.py` (registration endpoint), `process_deployment.py` (VM-based deployment), `login.py` (Deployment model), `database.py` (migrations)

### MAJOR ARCHITECTURE CHANGE - Process-Based Deployment (Like Vercel/Netlify)
- **New Deployment Model**: Replaced Docker containerization with direct process execution
- **Rationale**: Simpler UX, faster deployments, more flexible (users specify commands), feels like Vercel/Netlify
- **Note**: This is now combined with VM-based deployment - processes run inside user VMs, not on host Mac
- **Removed Files**:
  - `docker_build.py` - Docker image building (removed)
  - `docker_run.py` - Docker container management (removed)
  - `dockerfile_templates/` - Dockerfile templates directory (removed)
- **New Files**:
  - `vm_manager.py` - Manages OrbStack VMs for user isolation (creates, starts, stops, executes commands in VMs)
  - `process_manager.py` - Manages processes (start, stop, restart, logs, health checks) - NOW RUNS INSIDE VMs
  - `process_deployment.py` - Process-based deployment handler (replaces Docker deployment) - NOW DEPLOYS TO VMs
- **Database Changes**: Added fields to `Deployment` model:
  - `build_command` (TEXT) - Build command (e.g., "npm install && npm run build")
  - `start_command` (TEXT) - Start command (e.g., "npm run start")
  - `port` (INTEGER) - Port number
  - `process_pid` (INTEGER) - Process ID for tracking
  - `project_dir` (TEXT) - Persistent project directory (projects stored in `projects/` folder)
- **Auto-Detection**: Automatically detects build/start commands from package.json, requirements.txt, etc.
- **Process Management**: Uses subprocess.Popen for direct process execution, no Docker needed
- **Logs**: Real-time log streaming from process stdout/stderr
- **Health Checks**: Process status and port accessibility monitoring
- **UI Updates**:
  - Added optional build/start command and port fields in deploy form (Advanced Options)
  - Updated project cards to show port and PID instead of container uptime/image
  - Updated configuration page to show process fields (port, PID, start command, build command)
  - Updated component cards to show process info
  - Removed all Docker/container references from UI
- **Requirements**: Removed `docker==7.0.0` dependency (no longer needed)
- **Location**: `process_manager.py`, `process_deployment.py`, `login.py` (Deployment model), `database.py` (migrations), `orchestrator.py` (updated endpoints), `frontend/src/` (UI updates)
- **Branch**: `no_containerize` - All changes pushed to this branch

## Previous Updates

### Bug Fixes - Port Conflict Resolution
- **Auto Port Cleanup**: `orchestrator.py` now automatically kills processes on port 8000 before starting
- **Problem**: "Address already in use" error occurred when orphaned uvicorn processes weren't cleaned up
- **Solution**: Added `free_port_8000()` function that runs before server startup to check and kill any processes using port 8000
- **Location**: Lines 1689-1718 in `orchestrator.py`

### Bug Fixes - JSON Parsing Error on Login & 500 Error Handling
- **Fixed JSON Parse Error**: `frontend/src/js/auth.js` now handles non-JSON responses gracefully
- **Problem**: "JSON.parse: unexpected character" error when server returned HTML error pages or invalid responses
- **Solution**: Changed from `response.json()` to `response.text()` first, then try parsing JSON with proper error handling
- **Location**: Login function (lines 116-131) and Register function (lines 215-230) in `auth.js`
- **Note**: Frontend must be rebuilt after this change (`npm run build` in frontend directory)

### Bug Fixes - Global Exception Handler & Bcrypt Error Handling
- **Global Exception Handler**: Added `@app.exception_handler(Exception)` in `orchestrator.py` to ensure all errors return JSON
- **Problem**: Unhandled exceptions returned plain text "Internal Server Error" instead of JSON
- **Solution**: Global handler catches all exceptions and returns proper JSON error responses
- **Location**: Lines 169-193 in `orchestrator.py`
- **Bcrypt Error Handling**: Added try-catch blocks in `auth.py` for password verification to handle bcrypt compatibility issues
- **Location**: `verify_password()` and `authenticate_user()` functions in `auth.py`

### Environment Configuration
- **Google AI API Key**: Added `GOOGLE_AI_API_KEY` to `.env` file for Google AI integration

### New Features - Environment Variable Detection
- **Smart Detection**: Automatically detects env vars from repository code before deployment
- **Detection Dialog**: Shows detected vars with 3 options: Import All, Add Manually, No Skip
- **Pattern Matching**: Detects vars from process.env, os.getenv, os.environ, etc.
- **Built-in Filter**: Ignores common system vars (NODE_ENV, PATH, HOME, etc.)
- **Auto-Import**: One-click import of all detected vars with empty values
- **Multi-Repo Support**: Scans both frontend and backend repos for vars
- **Config File Priority**: Prioritizes vars found in next.config, .env.example, etc.
- **Node.js Deployment Fix**: Deployment now warns about missing env vars instead of failing

### UI/UX Improvements
- **Settings Page Redesign**: Modern layout with profile picture, password modal, toast notifications
- **Avatar Storage**: Moved from `static/avatars/` to `uploads/avatars/` to prevent deletion on frontend rebuild
- **Logo Update**: Replaced "DB" text with devops.png image in all sidebars
- **Terminology Update**: All user-facing "split repository" → "multi-repository" (internal code unchanged for compatibility)
- **Env Var Drag & Drop**: Environment Variables page now has a drag-and-drop `.env` upload drop zone that automatically imports dropped files (`frontend/src/index.html`, `frontend/src/js/app.js`, `frontend/src/css/styles.css`)
- **Log Stream Parsing**: WebSocket log clients now auto-detect plain-text messages, avoiding JSON parse errors during deployments (`frontend/src/js/app.js`)
- **Env Var Timestamp Display**: Environment Variables list now shows precise timestamps formatted in Kathmandu time, and log timestamps follow the same zone (`frontend/src/js/app.js`)
- **Per-Project Subdomains**: Projects can claim Cloudflare-hosted subdomains like `project-butler.example.com` (single label before base domain); backend syncs tunnel ingress/DNS, prevents cross-account reuse, and frontend manages status with a single save button & Open Site now prefers the custom host (`cloudflare_manager.py`, `orchestrator.py`, `frontend/src/js/app.js`, `frontend/src/css/styles.css`). Users can register a domain before the first deploy (status `pending`), and the deploy button now blocks only when no domain is configured, guiding them via a modal.

### Bug Fixes
- **Split Repo Deletion**: Fixed cascade deletion of child components when deleting parent
- **Avatar Disappearance**: Fixed avatars being deleted when running npm build (moved to uploads/)
- **2FA Removal**: Removed non-functional 2FA section from Settings page
- **Node.js Deployment**: Fixed deployment failing when env vars are missing (now continues with warning)

### Other New Features
- **Password Modal**: Added change password modal with real-time strength indicator
- **Toast Notifications**: Added success/error/info toast system for user feedback
- **Avatar Management**: Profile picture upload, display, removal with persistent storage

### Environment Variables Simplification
- **Removed Project Selector**: No more dropdown to switch between projects
- **Current Project Only**: Env vars page only shows/manages vars for currently selected project
- **No Global Variables**: Removed "All Projects (Global)" option - all vars are project-specific
- **Clearer UX**: Users must select a project from Projects page to manage its env vars

## Frontend Files

### Main Application
- **Main HTML**: `frontend/src/index.html` - Single page application with all pages
- **Main JavaScript**: `frontend/src/js/app.js` - Client-side routing, project management, API calls
- **Main Styles**: `frontend/src/css/styles.css` - All CSS styles including modals, buttons, cards
- **Built Output**: `static/` directory - Production build output served by FastAPI

### Key Frontend Functions
- **Delete Project**: `frontend/src/js/app.js` - `deleteProject(projectId)` function at line ~128
- **Delete Confirmation Dialog**: `frontend/src/js/app.js` - `showDeleteConfirmation(projectName)` at line ~182 (simple minimal dialog)
- **Multi-Repository Import Dialog**: `frontend/src/js/app.js` - `showSplitImportDialog()` at line ~2967
  - **User-Facing Text**: "Import as Multi-Repository?"
  - **Internal**: Still uses split-* CSS classes and split API calls
- **Project Name Modal**: `frontend/src/js/app.js` - `openProjectNameModal()` at line ~1519
- **Project Logs Modal**: `frontend/src/js/app.js` - `showProjectLogsModal()` at line ~889
- **Project Components Display**: `frontend/src/js/app.js` - `loadAndDisplayProjectComponents()` at line ~1599
  - **Location**: ALWAYS displayed on Deploy page ONLY (never on Configuration page)
  - **Visibility**: Only shown when BOTH frontend AND backend are deployed (not just imported) AND deploy page is visible
  - **Animation**: Slides in with fade, pushes deploy card down smoothly
  - **CSS**: `.project-components-card` with `.components-visible` class (line ~2480)
  - **Auto-refresh**: Refreshes after successful deployment for multi-repos
  - **Key Fix**: Function checks `deployPage.style.display !== 'none'` before showing components section
  - **Configuration Page**: Explicitly hides components section (line ~1581-1584)
- **Settings Management**: `frontend/src/js/app.js` - `loadSettings()`, `setupSettingsListeners()`, `handleProfileUpdate()`, `handlePasswordUpdate()`, `handleDeleteAccount()`, `showDeleteAccountConfirmation()`
  - **Password Modal**: Change password with real-time strength indicator (red/orange/green)
  - **Avatar Upload/Remove**: Profile picture management in `uploads/avatars/`
  - **Delete Account**: Delete account button with confirmation modal (shows warning about permanent deletion)
  - **Delete Account Modal**: Confirmation dialog with warning about what will be deleted (projects, deployments, environment variables, VM, account data)
  - **Account Deletion Flow**: Shows confirmation modal → Calls `DELETE /api/user/account` → Clears localStorage → Redirects to login page
  - **Toast Notifications**: Success/error/info messages for actions
- **Environment Variables Management**: `frontend/src/js/app.js` - `loadEnvVars()`, `saveEnvVars()`, `setupEnvVarsListeners()`
  - **No Project Selector**: Removed dropdown - uses `currentProject.id` exclusively
  - **Current Project Only**: Shows/manages vars for currently selected project only
  - **Import/Export**: Import from .env file, add/edit/delete variables
  - **Location**: Accessible via project sidebar → Environment Variables
- **Environment Variable Detection**: `frontend/src/js/app.js` - `showEnvVarsDetectionDialog()` at line ~1973
  - **Pre-Deploy Detection**: Automatically detects env vars from code when clicking "Deploy All"
  - **Detection Dialog**: Shows 3 options: Import All (auto-saves), Add Manually (navigates to env vars page), No Skip (proceeds)
  - **Auto-Import**: Merges detected vars with existing ones, saves to current project
  - **Integration**: Called in "Deploy All" button handler at line ~1389-1403
  - **API**: Uses `/api/env-vars/detect` endpoint with frontend_url & backend_url params
- **Multi-Repository Detection**: `frontend/src/js/app.js` - In `loadProjects()` function at line ~759
  - **Detection Logic**: Checks `git_url.startsWith('split::')` as most reliable method (works before and after deployment)
  - **Project Type**: Sets `project_type: 'split'` or `'single'` explicitly in project object
  - **Fallback**: Also checks status `'imported_split'` and parent_project_id for compatibility
  - **URL Parsing**: Extracts `frontend_url` and `backend_url` from `split::{frontend}|{backend}` format
- **Deploy Page Logic**: `frontend/src/js/app.js` - `showProjectContent('deploy')` at line ~1190
  - **Key Fix**: Always shows deploy page when clicking project (not configuration or components page)
  - **Project Type Detection**: Double-checks `git_url` format even if `project_type` is set
  - **Multi-Repos**: Shows multi layout (frontend/backend inputs) when `project_type === 'split'`
  - **Single Repos**: Shows single URL input when `project_type === 'single'`
  - **New Deploy**: Shows dropdown only when `currentProject` is null (from "+ New Deploy" button)
  - **Critical Fix**: Navigation between pages now reloads fresh project data to prevent stale state
- **Project Selection**: `frontend/src/js/app.js` - `selectProject(projectId)` at line ~1035
  - **Behavior**: Reloads projects before showing sidebar to ensure fresh data
  - **Initial Page**: Always calls `showProjectContent('deploy')` to show deploy page first
- **Navigation Fix**: `frontend/src/js/app.js` - Project sidebar navigation at line ~1145
  - **Critical Fix**: Project navigation now async reloads fresh data before showing page content
  - **Prevents**: Stale project data causing wrong deploy layout after deployment
  - **Flow**: await loadProjects() → update currentProject → showProjectContent(page)
- **Multi-Repository Deploy Button**: `frontend/src/js/app.js` - "Deploy All" button handler at line ~1348
  - **Critical Fix**: Changed from sequential `deploySingle()` calls to proper `/deploy` with `deploy_type='split'`
  - **Why**: Ensures proper parent/child relationship and uses `run_split_deployment()`
  - **Previous Bug**: Deployed as separate projects instead of linked components

### Frontend UI Components
- **Delete Button CSS**: `frontend/src/css/styles.css` - `.btn-delete` at line ~2109
- **Delete Confirmation Modal CSS**: `frontend/src/css/styles.css` - `.modal-overlay`, `.delete-confirmation-modal` at line ~1244
- **Project Cards**: `frontend/src/js/app.js` - `renderProjects()` at line ~806
- **Project Footer**: `frontend/src/js/app.js` - In `renderProjects()` template at line ~855

## Backend Files

### Core Application
- **Main FastAPI App**: `orchestrator.py` - Entry point, routes, WebSocket handlers
- **Database Models**: `login.py` - User, Deployment, EnvironmentVariable models
- **Database Setup**: `database.py` - Database engine, migrations, session management
- **VM Management**: `vm_manager.py` - OrbStack VM lifecycle management (create, start, stop, delete, exec commands)
- **Process Deployment**: `process_deployment.py` - VM-based process deployment (clones to VM, builds/runs inside VM)
- **Utilities**: `utils.py` - Utility functions (validate_git_url, extract_repo_name)
- **Process Management**: `process_manager.py` - Process lifecycle management (legacy, processes now run directly in VMs)
- **Authentication**: `auth.py` - User authentication, registration, and VM creation on user registration
- **Cloudflare Manager**: `cloudflare_manager.py` - Cloudflare tunnel and DNS management for domain routing

### API Endpoints (orchestrator.py)
- **Health Check**: `GET /health` - Line ~252
- **Deploy**: `POST /deploy` - Line ~574 (handles single & split deployments)
  - **Parameters**: `deploy_type` ('single' or 'split'), `git_url` or `frontend_url`+`backend_url`, optional `project_id`, optional `component_type`
  - **Split Flow**: Line 642-647 - Uses `project_id` as `parent_id` if provided, calls `run_split_deployment()`
  - **Single Flow**: Line 648-680 - Reuses existing deployment if `project_id` provided without `component_type`, or deploys as child component if `component_type` provided
  - **Component Deployment**: Line 667-668 - When `component_type` provided, uses `project_id` as `parent_id` for child deployment
  - **Environment**: Loads user env vars into temp directory as `frontend.env` and `backend.env` (lines 622-636)
- **List Deployments**: `GET /deployments` - Line ~908 (filters out child components with `parent_project_id IS NULL`)
- **Get Project Components**: `GET /projects/{project_id}/components` - Line ~969 (returns frontend/backend children)
- **Delete Project**: `DELETE /projects/{project_id}` - Line ~1204
  - **Cascade Deletion**: Now deletes all child components (containers, images, env vars, DB records)
  - **Split Repo Support**: Stops/removes all frontend/backend containers when deleting parent
- **Import Repository**: `POST /api/import` - Line ~745 (single repo, creates parent with git_url)
- **Import Multi-Repository**: `POST /api/import-split` - Line ~822 (frontend + backend, creates parent with `split::` git_url)
  - **Key Format**: Line 821 - Creates git_url as `split::{frontend_url}|{backend_url}`
  - **Status**: Sets status to `'imported_split'` (line 827)
  - **Naming**: Auto-generates app_name as `{fe_name}-{be_name}` (lines 816-819)
- **Authentication - Login**: `POST /api/auth/login` - Line ~278
  - **Request Format**: JSON body with Pydantic model `UserLogin` (username, password)
  - **NOT form data**: Endpoint expects `Content-Type: application/json`
  - **Request Body**: `{"username": "string", "password": "string"}`
  - **Response**: Returns `{"access_token": "...", "token_type": "bearer", "username": "..."}`
  - **Token Expiry**: 30 minutes (line 299)
  - **Auth**: No authentication required (public endpoint)
- **Authentication - Register**: `POST /api/auth/register` - Line ~358
  - **Request Format**: JSON body with Pydantic model `UserRegister` (username, email, password)
  - **Request Body**: `{"username": "string", "email": "string", "password": "string"}`
  - **Response**: Returns `{"message": "User created successfully"}`
  - **Auth**: No authentication required (public endpoint)
  - **VM Creation**: Automatically creates OrbStack VM for new user (asynchronous, non-blocking)
  - **VM Name**: Format `butler-user-{user_id}` (e.g., "butler-user-1")
  - **VM Setup**: Installs dependencies (git, nodejs, python3, etc.) in VM after creation
  - **Error Handling**: User registration succeeds even if VM creation fails (VM will be created on first deployment)
- **User Profile**: `GET /api/user/profile` - Line ~462 (returns user data including avatar_url)
- **Update Profile**: `PUT /api/user/profile` - Line ~473 (handles avatar upload, password change, profile updates)
  - **Avatar Storage**: Saves to `uploads/avatars/` (NOT `static/avatars/` to prevent deletion on build)
  - **Avatar URL**: Returns `/avatars/{user_id}_{random}.{ext}` format
  - **Avatar Serving**: FastAPI mounts `/avatars` from `uploads/avatars/` directory
- **Delete Account**: `DELETE /api/user/account` - Line ~2078 (deletes user account and all associated data)
  - **Deletion Process**: Stops all processes in user's deployments (inside VM), removes Cloudflare DNS records, deletes project directories, deletes all environment variables, deletes all deployments (including child deployments), deletes the user's OrbStack VM, and finally deletes the user account
  - **VM Deletion**: Checks if VM exists before deletion (even if no deployments reference it), stops VM, then deletes it
  - **Error Handling**: Continues with deletion even if individual steps fail (logs errors but doesn't stop)
  - **Response**: Returns `{"message": "Account deleted successfully"}` on success
  - **Authentication**: Requires Bearer token (`current_user: User = Depends(get_current_user)`)
- **Environment Variables API**: `GET /api/env-vars` - Line ~383 (get vars for current project)
- **Environment Variables API**: `POST /api/env-vars` - Line ~409 (save vars for current project)
- **Environment Variable Detection**: `GET /api/env-vars/detect` - Line ~461
  - **Path**: `/api/env-vars/detect` (full path, no routing conflicts)
  - **Request**: Query parameters (`?frontend_url=...&backend_url=...` or `?git_url=...`)
  - **Parameters**: `frontend_url`, `backend_url`, or `git_url` (for single repo)
  - **Authentication**: Requires Bearer token (`current_user: User = Depends(get_current_user)`)
  - **Functionality**: Clones repos to temp directory, scans code for env var patterns, returns suggestions
  - **Timeout**: 60 seconds per git clone operation
  - **Helper Function**: `_detect_env_from_repo()` - Line ~523
    - **Patterns**: process.env, os.getenv, os.environ, ${VAR}, env()
    - **Config Files**: next.config, .env.example, package.json, settings.py, etc.
    - **Filter**: Ignores common vars (NODE_ENV, PATH, HOME, etc.)
    - **Priority**: Vars from config files get higher priority (10 vs 5)
  - **Response**: `{"suggestions": {"VAR_NAME": {"detected_from": "file", "source": "process.env", "component": "frontend", "priority": 10}}}`
  - **Error Handling**: Returns empty suggestions dict on error (doesn't fail deployment)

### Deployment Logic (process_deployment.py)
- **Main Pipeline**: `run_process_deployment()` - Line ~222 (handles VM-based deployments)
  - **VM-Based**: Gets or creates user's VM, clones repo inside VM, builds/runs inside VM
  - **VM Paths**: Projects stored in `/projects/{project_id}` inside VM
  - **Process Management**: Starts processes in background using `nohup` inside VM
  - **Domain Generation**: Auto-generates domain as `project-name.butler.aayush786.xyz`
  - **Cloudflare Integration**: Automatically configures Cloudflare tunnel after deployment
- **VM Operations**: 
  - **Clone**: `vm_manager.exec_in_vm()` to clone repo inside VM
  - **Build**: `vm_manager.exec_in_vm()` to execute build commands inside VM
  - **Start**: `vm_manager.exec_in_vm()` to start process in background inside VM
  - **Process Tracking**: PID stored in `/tmp/project-{id}.pid`, logs in `/tmp/project-{id}.log`
- **Domain Configuration**: 
  - **Format**: `project-name.butler.aayush786.xyz` (extracted from project name or repo name)
  - **Service URL**: `http://localhost:{port}` (OrbStack forwards VM ports to host)
  - **Cloudflare**: Automatically configures tunnel ingress and DNS records
- **Monorepo Support**: Detects frontend/backend folders, deploys separately with environment variable linking
- **Split Repo Support**: Deploys frontend and backend from separate repos, connects via environment variables
- **Command Auto-Detection**: Detects build/start commands with priority: 1) User-provided, 2) AI analysis results from database, 3) Dockerfile/docker-compose (via dockerfile_parser), 4) File-based detection (package.json, requirements.txt, etc.). AI analysis results take priority over file-based detection when available.
- **URL Validation**: `validate_git_url()` - In `utils.py`
- **Repo Name Extraction**: `extract_repo_name()` - In `utils.py`

### Database Models (login.py)
- **User Model**: Line ~6 - Authentication, profile, tokens
- **Deployment Model**: Line ~22 - Container deployments with parent_project_id, component_type
- **EnvironmentVariable Model**: Line ~53 - User env vars per project

### Database Migrations (database.py)
- **Table Creation**: `create_db_and_tables()` - Line ~14
- **Column Migrations**: Lines ~25-63 - Adds app_name, updated_at, user_id, parent_project_id, component_type, build_command, start_command, port, process_pid, project_dir, vm_name, vm_ip, host_port

## Split Repository Feature

### Database Schema
- **Parent Project**: Deployment with `parent_project_id = None`, `component_type = None`
- **Frontend Component**: Deployment with `parent_project_id = parent_id`, `component_type = 'frontend'`
- **Backend Component**: Deployment with `parent_project_id = parent_id`, `component_type = 'backend'`

### How Multi-Repositories Work (formerly "Split Repos")
- **User-Facing Name**: "Multi-Repository (Frontend + Backend)"
- **Internal Code**: Still uses "split" for API compatibility (deploy_type='split', split:: format, etc.)
1. **Import**: User imports via `/api/import-split` - creates parent with status 'imported_split' and git_url='split::{frontend}|{backend}'
2. **Deploy**: User clicks "Deploy All" - uses `/deploy` with `deploy_type='split'` which calls `run_split_deployment()`
3. **Deploy Process**: `run_split_deployment()` creates/uses parent, then deploys backend then frontend as children
4. **Display**: Dashboard shows only parent projects (`parent_project_id IS NULL` filter)
5. **Details**: Configuration page shows components via `/projects/{id}/components` endpoint
6. **Deletion**: Deleting parent now cascades to all children (containers, images, env vars, DB records)

### Multi-Repository Detection (Critical)
- **Most Reliable**: `git_url.startsWith('split::')` - works before AND after deployment
- **Status Fallback**: `status === 'imported_split'` - only before deployment
- **Database Integrity**: Parent MUST have `parent_project_id = NULL` and `component_type = NULL`
- **Children**: Must have `parent_project_id = parent.id` and `component_type = 'frontend'|'backend'`
- **Import Format**: `/api/import-split` creates git_url = `split::{frontend_url}|{backend_url}` (line 821)
- **Deploy Format**: `run_split_deployment()` uses same format when creating parent (line 1119)

### Deploy Page Behavior
- **New Deploy** (from "+ New Deploy" button): Shows dropdown to choose single/multi, `currentProject` is null
- **Existing Multi-Repository Project**: Shows multi layout (frontend/backend inputs + "Deploy All") without dropdown, shows components section if both deployed
- **Existing Single Project**: Shows single URL input without dropdown
- **Key Fix**: Deploy page is ALWAYS shown when clicking on a project (not configuration or components page)
- **Components Section**: Only shown on deploy page, above "Deploy New Application" card, when both frontend and backend are deployed
- **Critical Bug Fixed**: Multi-repo showing single-repo form after deployment
  - **Root Cause**: Stale `currentProject` object after deployment, missing parent project in database
  - **Solution**: Navigation reloads fresh data, ensure parent has `git_url` in `split::` format

## CSS Class Reference

### Buttons
- `.btn-primary` - Green primary button
- `.btn-secondary` - Gray secondary button  
- `.btn-dark` - Dark blue button (used for "Open Site")
- `.btn-danger` - Red button (delete actions)
- `.btn-delete` - Delete button on project cards (line ~2109)
- `.btn-block` - Full-width button

### Modals
- **All Modal CSS**: `frontend/src/css/styles.css` - Lines ~1217-1566
- **Modal Overlay**: `.modal-overlay` (line ~1245) - Fixed overlay backdrop
- **Modal Content**: `.modal-content` (line ~1230) - Base modal container
- **Enhanced Modal**: `.modal-content.enhanced` (line ~1324) - Wider modal variant

#### Delete Confirmation Dialog
- **JS Function**: `frontend/src/js/app.js` - `showDeleteConfirmation()` at line ~182
- **CSS**: `.delete-confirmation-modal` (line ~1258), `.delete-confirmation-actions` (line ~1286)

#### Split Import Dialog
- **JS Function**: `frontend/src/js/app.js` - `showSplitImportDialog()` at line ~2239
- **CSS Classes**: Lines ~1373-1474
  - `.split-import-modal-center` - Centered header section
  - `.split-import-icon-wrapper` - Icon container
  - `.split-import-repo-info` - Repository details container
  - `.split-import-actions` - Action buttons container

#### Project Name Modal
- **JS Function**: `frontend/src/js/app.js` - `openProjectNameModal()` at line ~1519
- **CSS Classes**: Lines ~1476-1566
  - `.project-name-modal-header` - Header section
  - `.project-name-modal-form-group` - Input form group
  - `.project-name-modal-actions` - Action buttons container
  - `.cancel-name-btn`, `.save-name-btn` - Button styles

#### Project Logs Modal
- **JS Function**: `frontend/src/js/app.js` - `showProjectLogsModal()` at line ~889
- **CSS**: `.logs-modal` (line ~1678), `.modal-header`, `.modal-body`, `.modal-footer`

### Project Cards
- `.project-card` - Individual project card container
- `.project-header` - Card header with icon and status
- `.project-info` - Card body with name and metadata
- `.project-footer` - Footer with action buttons
- `.project-status` - Status badge (RUNNING, IMPORTED, etc.)

## File Structure

```
Devops_Butler/
├── orchestrator.py          # FastAPI main app
├── process_deployment.py    # VM-based deployment logic
├── vm_manager.py            # OrbStack VM management
├── project_analyzer.py      # AI project analysis (Gemini)
├── utils.py                 # Utility functions
├── login.py                 # Database models
├── database.py              # DB setup & migrations
├── auth.py                  # Authentication & user management
├── cloudflare_manager.py    # Cloudflare tunnel & DNS
├── process_manager.py       # Process management (legacy)
├── frontend/
│   ├── src/
│   │   ├── index.html       # Main SPA
│   │   ├── js/
│   │   │   └── app.js       # All frontend logic
│   │   └── css/
│   │       └── styles.css   # All styles
│   └── package.json
├── static/                  # Built frontend (served by FastAPI)
├── uploads/
│   └── avatars/             # User profile pictures (not deleted on build)
└── icons/                   # Application icons (logo.png, devops.png)
```

## Key Concepts

### Project Status Values
- `'running'` - Container is currently running
- `'imported'` - Repository imported but not deployed
- `'imported_split'` - Split repo imported but not deployed
- `'success'` - Deployment succeeded (may be stopped)
- `'failed'` - Deployment failed

### Component Types
- `None` - Standalone or parent project
- `'frontend'` - Frontend component of split repo
- `'backend'` - Backend component of split repo

### Git URL Formats
- Normal: `https://github.com/user/repo.git`
- Split: `split::{frontend_url}|{backend_url}`

## Common Tasks

### Add New API Endpoint
1. Add route in `orchestrator.py`
2. Add authentication if needed: `current_user: User = Depends(get_current_user)`
3. Use database session: `with Session(engine) as session:`

### Modify Frontend Page
1. Edit HTML in `frontend/src/index.html`
2. Edit logic in `frontend/src/js/app.js`
3. Edit styles in `frontend/src/css/styles.css`
4. Run `cd frontend && npm run build` to compile

### Change Database Schema
1. Update model in `login.py`
2. Add migration in `database.py` `create_db_and_tables()` function
3. Server auto-applies on restart

### API Authentication & Request Formats
- **Login/Register**: Expect JSON body (`Content-Type: application/json`), NOT form data
  - Login: `POST /api/auth/login` with `{"username": "...", "password": "..."}`
  - Register: `POST /api/auth/register` with `{"username": "...", "email": "...", "password": "..."}`
- **Authenticated Endpoints**: Most API endpoints require Bearer token in `Authorization` header
  - Format: `Authorization: Bearer {access_token}`
  - Token obtained from login endpoint, valid for 30 minutes
- **Query Parameters**: Some endpoints use query params (e.g., `/api/env-vars/detect?frontend_url=...`)
- **Form Data**: Deployment endpoint (`/deploy`) uses `Form` data, not JSON

### Debugging
- Backend logs: Terminal running `orchestrator.py`
- Frontend console: Browser DevTools
- Database: `deployments.db` SQLite file
- **API Testing**: Use curl with proper Content-Type headers:
  - JSON: `curl -X POST -H "Content-Type: application/json" -d '{"username":"..."}' ...`
  - Auth: `curl -H "Authorization: Bearer {token}" ...`

### Multi-Repository Flow (Complete) - User-facing name for what was "Split Repository"
1. **User imports multi-repo** → `/api/import-split` creates parent with:
   - `git_url = "split::{frontend_url}|{backend_url}"` (line 821)
   - `status = 'imported_split'` (line 827)
   - `parent_project_id = None`, `component_type = None`
   - Returns project_id
2. **User clicks "Deploy All"** → Frontend sends to `/deploy`:
   - `deploy_type = 'split'`, `frontend_url`, `backend_url`, `project_id`
   - Backend receives `project_id` as `parent_id` (line 646)
   - Calls `run_split_deployment(parent_project_id=parent_id)`
3. **Backend deployment** → `run_split_deployment()` at line 1096:
   - Checks if `parent_project_id` is None → creates parent if needed (line 1115)
   - Creates parent with `split::` format git_url (line 1119)
   - Deploys backend first as child (line 1141) with `component_type='backend'`
   - Deploys frontend second as child (line 1148) with `component_type='frontend'`
   - Children link to parent via `parent_project_id`
4. **Individual Frontend/Backend deployment** → User clicks "Deploy Frontend" or "Deploy Backend":
   - Frontend sends to `/deploy`: `deploy_type='single'`, `component_type='frontend'|'backend'`, `project_id=parent`
   - Backend receives `project_id` as parent and `component_type` (line 667-668)
   - Calls `run_deployment_pipeline()` with `parent_project_id` and `component_type` (lines 673-680)
   - Pipeline finds existing child by `parent_project_id + component_type` or creates new child (lines 831-861)
   - Updates existing child if found, otherwise creates new child linked to parent
5. **Frontend displays** → Dashboard loads:
   - `/deployments` returns only parents (`parent_project_id IS NULL`)
   - Multi-repos detected by `git_url.startsWith('split::')`
   - Deploy page shows multi form with pre-filled URLs
   - Config page shows components section with frontend/backend cards
6. **User deletes multi-repo** → `DELETE /projects/{parent_id}`:
   - Stops process inside VM (if process_pid exists)
   - Removes Cloudflare DNS record (if custom_domain exists)
   - Deletes project directory from VM (verifies existence before deletion)
   - Finds all children where `parent_project_id = parent_id`
   - For each child: stops process, removes directory from VM, removes Cloudflare DNS, deletes env vars, deletes DB record
   - Deletes parent's env vars and DB record
   - Then deletes parent
7. **User deletes account** → `DELETE /api/user/account`:
   - Stops all processes in user's deployments (inside VM)
   - Removes all Cloudflare DNS records for user's domains
   - Deletes all project directories inside VM
   - Deletes all project directories on host (legacy deployments)
   - Deletes all environment variables
   - Deletes all deployments (including child deployments)
   - Deletes the user's OrbStack VM
   - Deletes the user account from database
   - Redirects to login page after successful deletion

